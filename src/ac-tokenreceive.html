<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="../bower_components/sc-style/sc-style.html">
<link rel="import" href="../bower_components/sc-iconset/sc-iconset.html">
<link rel="import" href="ac-helpers.html">
<link rel="import" href="ac-whisperer.html">
<link rel="import" href="ac-config.html">
<link rel="import" href="ac-log.html">
<link rel="import" href="ac-wallet.html">
<link rel="import" href="ac-ipfs.html">

<dom-module id="ac-tokenreceive">
<link rel="import" href="../bower_components/sc-style/sc-style.css" type="css">

  <template>
    <style>
      :host {
        display: inline-block;
        box-sizing: border-box;
        background-color: transparent;;
        --balance-h1: 40px;
        --balance-lineheight: 52px;
        --coin-margins: 0px 0px 7px 6px;
        --code-h2: 32px;
        --code-lineheight: 36px;
        --code-small: 10px;
        --btn-width: 200px;

      }

      .total {
        width: 100%;

        @apply(--layout-vertical);
      }

      .sendcoiners {
        width: 100%;
        max-width: 500px;
        box-sizing: border-box;
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }


      .flex {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
      }


     #sendcoins {
      width: 100%;

      box-sizing: border-box;
     }

     #receivecoins {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
     }


     .whitespace {
      width: 100%;
      height: 20px;
     }

     .code {
      margin: 0px 0px 0px 0px;
     }

     .code h2 {
      padding: 10px;
      box-sizing: border-box;
      color: var(--ac-yellow);
      @apply(--montserrat-reg);

     }

     .announce {
      width: 100%;
      height: 75px;
      box-sizing: border-box;
      @apply(--layout-vertical);
      @apply(--layout-center-center);
     }

     .announce p {
      color: var(--ac-yellow);
     }

     .marginbtm {
      margin-left: 15px;
      margin: var(--coin-margins);
     }


        .sender {
          margin: 0px 0px 5px 0px;
        }

      .sendinput {
        width: 100%;
        overflow: hidden;
      }

    </style>

    <iron-media-query query="(min-width:0px) and (max-width: 420px)" query-matches="{{phoneview}}"></iron-media-query>

    <ac-ipfs id="ipfs"></ac-ipfs>
    <ac-helpers id="helpers"></ac-helpers>
    <ac-config
      id="config"
      ipfs="{{ipfs}}"
      etherscanroot="{{etherscanroot}}"
      ></ac-config>

    <ac-whisperer
      web3="{{web3}}"
      topic="{{topic}}"
      progress="{{progress}}"
      listeninterval="{{listeninterval}}"
      decimals="5"
      on-message-received="handlewhispermessage"
      id="whisper"></ac-whisperer>

    <div class="totalwidth vertic centercenter">
      <div class="initbtns totalwidth">
        <template is="dom-if" if="{{_is(receivecoinstate,'init')}}">
          <ac-shortcode class="totalwidth" on-cancel="deactivatereceivecoins" bg="btncolor" txtcolor="red" topic="[[topic]]" progress="[[progress]]" on-showshortcode="activatereceivecoins" btn>shortcode</ac-shortcode>
        </template>

        <template is="dom-if" if="{{_is(receivecoinstate,'userinfosent')}}">
          <div class="announce">
            <p class="semibold">Sending your info to requesting party</p>
              <template is="dom-if" if="{{phoneview}}">
                <div class="whitespace"></div>
              </template>
            <sc-loader small color="blue"></sc-loader>

            <template is="dom-if" if="{{probablytimedout}}">
              <template is="dom-if" if="{{phoneview}}">
                <div class="minispace"></div>
              </template>
              <iron-icon icon="sc-icons:decline" class="grey3 medium" on-tap="deactivatereceivecoins">decline</iron-icon>
            </template>

          </div>
        </template>

        <template is="dom-if" if="{{_is(receivecoinstate,'waitforconfirmation')}}">
            <p class="semibold">Waiting for confirmation from</p>
              <div class="receiver">
                <div class="receiveravatar">
                  <img src="{{sender.avatarurl}}"></div>
                <div class="receiverusername">
                  <p>{{sender.username}}</p>
                </div>
              </div>
        </template>

       <template is="dom-if" if="{{_is(receivecoinstate,'txdeclined')}}">
          <div class="announce">
            <p class="bold">Transaction aborted by other party</p>
              <template is="dom-if" if="{{phoneview}}">
                <div class="minispace"></div>
              </template>
              <iron-icon icon="sc-icons:decline" class="grey3 medium" on-tap="deactivatereceivecoins">decline</iron-icon>
          </div>
        </template>

        <template is="dom-if" if="{{_is(receivecoinstate,'txconfirmed')}}">
          <div class="announce">
            <p class="bold">You received {{formatpong(receivedamount)}} tokens.</p>

              <template is="dom-if" if="{{phoneview}}">
                <div class="minispace"></div>
              </template>
              <iron-icon icon="sc-icons:decline" class="grey3 medium" on-tap="deactivatereceivecoins">decline</iron-icon>
          </div>
        </template>

        <template is="dom-if" if="{{_is(receivecoinstate,'transfererror')}}">
          <div class="announce">
            <p class="bold">Transaction failed {{receivecoinstateerror}}.</p>
              <template is="dom-if" if="{{phoneview}}">
                <div class="minispace"></div>
              </template>
              <iron-icon icon="sc-icons:decline" class="grey3 medium" on-tap="deactivatereceivecoins">decline</iron-icon>
          </div>
        </template>
        
      </div>
  </div>
</template>
<script>
  (function() {
    'use strict';

    Polymer({
      is: 'ac-tokenreceive',

      properties: {


        account: {
          type:String,
        },

        sendcoinstate: {
          type: String,
          value: 'first',
        },

        collsclosed: {
          type: Boolean,
          value: true
        },

        receivecollsclosed: {
          type: Boolean,
          value: true
        },

        history: {
          type: Array,
          value: []
        },

        align: {
          type: String,
        },

        identity: {
          type: Object,
        },
      },

      _pincode: function() {
        console.log(this.pincode);
      },

      ready: function(){
        var self = this;
        this.receivecoinstate = 'init';
        this.probablytimedout = 'true';
      },

      activatereceivecoins: function(){
        this.fire('activated');
        this.listeninterval = 60;
      },

      deactivatereceivecoins: function(){
        this.fire('deactivated');
        this.receivecoinstate = 'init';
        this.listeninterval = 0;
      },

      attached: function(){
      },

      // receiving side
      handlewhispermessage: function(m) {
        var self = this;
        var message = JSON.parse(m.detail.message);
        console.log('incoming tokentransfer msg: ', message);
        switch (message.command) {
          case 'requestuserinfo':
            self.$.whisper.whisperpost(m.detail.from, JSON.stringify({
              'command': 'userinfo',
              'account': self.account,
              'avatarhash': self.identity.avatarhash,
              'username': self.identity.username,
            }));
            this.receivecoinstate = 'userinfosent';
            break;
          case 'waitforconfirmation':
            // peer is deciding to send your tokens or not
            this.receivecoinstate = 'waitforconfirmation';
            this.sender = {
              avatarurl: this.$.ipfs.geturl(this.message.avatarhash),
              username: this.message.username
            };
            break;
          case 'txdeclined':
            this.receivecoinstate = 'txdeclined';
            break;
          case 'confirmtransfer':
            // TODO : show transfer in history...
            console.log('transfer confirmed...', message.amount, 'received');
            this.transactiondetails = message;
            this.transactiondetails.avatarurl = this.$.ipfs.geturl(this.transactiondetails.avatarhash);
            this.receivecoinstate = 'txconfirmed';
            this.receivedamount = self.transactiondetails.amount;

            this.fire('addlog',
              {
                avatarhash:self.transactiondetails.avatarhash,
                fromusername:self.transactiondetails.username,
                amount:self.transactiondetails.amount,
                txhash:self.transactiondetails.txhash,
                status:'pending'
              });


            // TODO : wait for the transactionID... now we just fake this , allemaal voor dat den BAN voortkan he. achteraf vervangen we dit door een transaction monitor.

            // setTimeout(function() {
            //     this.receivecoinstate = 'init';
            //     this.listeninterval = 0;
            //   }.bind(this), 50 * 1000);

            break;
          case 'transfererror':
         
            this.receivecoinstate = 'transfererror';
            this.receivecoinstateerror = message.error;


            break;

          default:
            console.log('unknown message', message);
        }
      },

      clearInputs: function(){
        this.pincode = '';
        this.amount = '';
      },

    toHome: function() {
      this.fire('to-home');
    },


    _is: function(a, b) {
      if (b === undefined){
        b = true;
      }
      return a === b;
    },

    
    formatpong: function(val){
      return (0 + (val / 1e18)).toFixed(2);
    },


    });
  })();
  </script>
</dom-module>