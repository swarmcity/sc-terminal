<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/sc-style/sc-style.html">
<link rel="import" href="../bower_components/sc-iconset/sc-iconset.html">
<link rel="import" href="ac-helpers.html">
<link rel="import" href="ac-whisperer.html">
<link rel="import" href="ac-config.html">
<link rel="import" href="ac-log.html">
<link rel="import" href="ac-wallet.html">
<link rel="import" href="ac-ipfs.html">

<dom-module id="ac-tokenreceive">
<link rel="import" href="../bower_components/sc-style/sc-style.css" type="css">

  <template>
    <style>
      :host {
        display: inline-block;
        box-sizing: border-box;
        background-color: transparent;;
        --balance-h1: 40px;
        --balance-lineheight: 52px;
        --coin-margins: 0px 0px 7px 6px;
        --code-h2: 32px;
        --code-lineheight: 36px;
        --code-small: 10px;
        --btn-width: 200px;
        width: 100%;

      }

      h1 {
        @apply(--ac-font-h1);
        text-align: center;
        font-size: var(--balance-h1);
        line-height: var(--balance-lineheight);
      }


      h2 {
        @apply(--ac-font-h2);
        @apply(--opensans-semibold);
        font-size: var(--code-h2);
        line-height: var(--code-lineheight);
      }

      p {
        @apply(--ac-font-body1);
      }

      small {
        @apply(--ac-font-small);
        @apply(--opensans-semibold);
        font-size: var(--code-small);
      }


      .total {
        width: 100%;

        @apply(--layout-vertical);
      }

      .sendcoiners {
        width: 100%;
        max-width: 500px;
        box-sizing: border-box;
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }


      .flex {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
      }


     #sendcoins {
      width: 100%;

      box-sizing: border-box;
     }

     #receivecoins {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
     }


     .whitespace {
      width: 100%;
      height: 20px;
     }

     .code {
      margin: 0px 0px 0px 0px;
     }

     .code h2 {
      padding: 10px;
      box-sizing: border-box;
      color: var(--ac-yellow);
      @apply(--montserrat-reg);

     }



     .announce {
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      @apply(--layout-vertical);
      @apply(--layout-center-center);
     }

     .announce p {
      color: var(--ac-yellow);
     }

     .marginbtm {
      margin-left: 15px;
      margin: var(--coin-margins);
     }


      .initbtns {
/*        @apply(--layout-vertical);
        @apply(--layout-center-center);*/

      }

      .initbtns ac-button {
        width: 200px;
        @apply(--base-shadow-and-inset);
      }

      ac-shortcode {
        width: 200px;
      }

      .initbtns p {
        color: var(--ac-yellow);
        @apply(--montserrat-semibold);
        margin-top:10px;
        border-bottom: 1px dashed var(--ac-yellow);
        font-size: 16px;
      }

      .confirmbtns {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-end-justified);
        margin-top: 15px;
      }

      .confirmbtnsmobile {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        margin-top: 15px;
      }

        .confirmbtn {
          margin: 0px 2px 0px 2px;
        }

        .sender {
          margin: 0px 0px 5px 0px;
        }

      .verticcenter {
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }

      .verticstart {
        @apply(--layout-vertical);
        @apply(--layout-start);
        @apply(--layout-center-justified);
      }
      .horizontcenter {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }
      .horizontend {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-end);
      }

      .horizontcenterwrap {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-center-center);
      }
      .horizontstartwrap {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-start-justified);
      }

      .sendinput {
        width: 100%;
        overflow: hidden;
      }

    </style>
    <ac-ipfs id="ipfs"></ac-ipfs>
    <ac-helpers id="helpers"></ac-helpers>
    <ac-config
      id="config"
      ipfs="{{ipfs}}"
      etherscanroot="{{etherscanroot}}"
      ></ac-config>

    <ac-whisperer
      web3="{{web3}}"
      topic="{{topic}}"
      progress="{{progress}}"
      listeninterval="{{listeninterval}}"
      decimals="5"
      on-message-received="handlewhispermessage"
      id="whisper"></ac-whisperer>

    <div class="total vertic centercenter">
      <div class$="initbtns {{align}}">
        <template is="dom-if" if="{{_is(receivecoinstate,'init')}}">
          <ac-shortcode on-cancel="deactivatereceivecoins" bg="btncolor" txtcolor="red" topic="[[topic]]" progress="[[progress]]" on-showshortcode="activatereceivecoins" btn>shortcode</ac-shortcode>
        </template>

        <template is="dom-if" if="{{_is(receivecoinstate,'userinfosent')}}">
          <div class="announce">
            <div class="item red">
              <p>Sending user info for payment</p>
            </div>
          </div>
        </template>
      </div>
  </div>
</template>
<script>
  (function() {
    'use strict';

    Polymer({
      is: 'ac-tokenreceive',

      properties: {


        account: {
          type:String,
        },

        sendcoinstate: {
          type: String,
          value: 'first',
        },

        collsclosed: {
          type: Boolean,
          value: true
        },

        receivecollsclosed: {
          type: Boolean,
          value: true
        },

        history: {
          type: Array,
          value: []
        },

        align: {
          type: String,
        },

        identity: {
          type: Object,
        },
      },

      _pincode: function() {
        console.log(this.pincode);
      },

      ready: function(){
        var self = this;
        this.receivecoinstate = 'init';
      },

      activatereceivecoins: function(){
        this.listeninterval = 60;
      },

      deactivatereceivecoins: function(){
        this.listeninterval = 0;
      },

      attached: function(){
      },

      // receiving side
      handlewhispermessage: function(m) {
        var self = this;
        var message = JSON.parse(m.detail.message);
        console.log('incoming tokentransfer msg: ', message);
        switch (message.command) {
          case 'requestuserinfo':
            self.$.whisper.whisperpost(m.detail.from, JSON.stringify({
              'command': 'userinfo',
              'account': self.account,
              'avatarhash': self.identity.avatarhash,
              'username': self.identity.username,
            }));
            this.receivecoinstate = 'userinfosent';
            break;
          case 'confirmtransfer':
            // TODO : show transfer in history...
            //console.log('transfer confirmed...', message.amount, 'received');
            this.transactiondetails = message;
            this.transactiondetails.avatarurl = this.$.ipfs.geturl(this.transactiondetails.avatarhash);
//            this.receivecoinstate = 'waittx';

            this.fire('addlog',
              {
                avatarhash:self.transactiondetails.avatarhash,
                fromusername:self.transactiondetails.username,
                amount:self.transactiondetails.amount,
                txhash:self.transactiondetails.txhash,
                status:'pending'
              });


            // TODO : wait for the transactionID... now we just fake this , allemaal voor dat den BAN voortkan he. achteraf vervangen we dit door een transaction monitor.

            setTimeout(function() {
                this.receivecoinstate = 'init';
                this.listeninterval = 0;
              }.bind(this), 50 * 1000);

            break;
          default:
            console.log('unknown message', message);
        }
      },

      clearInputs: function(){
        this.pincode = '';
        this.amount = '';
      },

    toHome: function() {
      this.fire('to-home');
    },


    _is: function(a, b) {
      if (b === undefined){
        b = true;
      }
      return a === b;
    },

    });
  })();
  </script>
</dom-module>